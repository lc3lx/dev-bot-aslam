{% extends "base.html" %} {% block title %}صفحة المستخدم{% endblock %} {% block
content %}
<style>
  body {
    background: radial-gradient(
        900px 360px at 80% -10%,
        rgba(229, 9, 20, 0.25),
        transparent 70%
      ),
      #0b0b0f;
    color: #e5e7eb;
  }

  .user-page {
    padding-top: 10px;
  }

  .hero-banner {
    position: relative;
    border-radius: 24px;
    overflow: hidden;
    background: linear-gradient(120deg, #0b0b0f, #141824 55%, #0b0b0f 100%);
    color: #fff;
    padding: 36px 28px;
    box-shadow: 0 30px 80px rgba(15, 23, 42, 0.45);
  }

  .hero-banner::before,
  .hero-banner::after {
    content: "";
    position: absolute;
    inset: -50% -10% auto auto;
    width: 420px;
    height: 420px;
    background: radial-gradient(
      circle,
      rgba(229, 9, 20, 0.45) 0%,
      rgba(229, 9, 20, 0.08) 60%,
      transparent 70%
    );
    filter: blur(12px);
    animation: floatGlow 9s ease-in-out infinite;
  }

  .hero-banner::after {
    inset: auto auto -50% -10%;
    width: 360px;
    height: 360px;
    animation-delay: -3s;
    background: radial-gradient(
      circle,
      rgba(45, 212, 191, 0.35) 0%,
      rgba(45, 212, 191, 0.08) 60%,
      transparent 70%
    );
  }

  .hero-layout {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 24px;
  }

  .hero-content {
    max-width: 560px;
  }

  .hero-title {
    font-size: clamp(28px, 4vw, 40px);
    font-weight: 800;
    letter-spacing: 0.3px;
    margin-bottom: 10px;
    animation: slideFadeIn 0.9s ease both;
  }

  .hero-subtitle {
    font-size: clamp(14px, 2.2vw, 18px);
    opacity: 0.85;
    margin-bottom: 22px;
    animation: slideFadeIn 1.2s ease both;
  }

  .hero-actions .btn {
    border-radius: 999px;
    padding: 10px 22px;
    font-weight: 700;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .hero-actions .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 20px rgba(229, 9, 20, 0.25);
  }

  .hero-pill {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    background: rgba(255, 255, 255, 0.1);
    padding: 6px 14px;
    border-radius: 999px;
    text-transform: uppercase;
    letter-spacing: 1.2px;
    animation: pulseGlow 3s ease-in-out infinite;
  }

  .floating-stars span {
    position: absolute;
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.5);
    animation: twinkle 6s infinite ease-in-out;
  }

  .floating-stars span:nth-child(1) {
    top: 22%;
    right: 18%;
    animation-delay: -1s;
  }

  .floating-stars span:nth-child(2) {
    top: 45%;
    right: 32%;
    animation-delay: -3s;
  }

  .floating-stars span:nth-child(3) {
    top: 18%;
    right: 50%;
    animation-delay: -2s;
  }

  .floating-stars span:nth-child(4) {
    top: 62%;
    right: 20%;
    animation-delay: -4s;
  }

  .frost-card {
    background: rgba(15, 23, 42, 0.75);
    border-radius: 18px;
    border: 1px solid rgba(148, 163, 184, 0.2);
    box-shadow: 0 25px 50px rgba(15, 23, 42, 0.35);
    backdrop-filter: blur(6px);
    color: #e5e7eb;
  }

  .user-page .card-title,
  .user-page label {
    color: #f8fafc;
  }

  .user-page .text-muted {
    color: rgba(226, 232, 240, 0.7) !important;
  }

  .service-button {
    border-radius: 14px;
    font-weight: 600;
    transition: transform 0.15s ease, box-shadow 0.2s ease;
  }

  .service-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 24px rgba(15, 23, 42, 0.15);
  }

  .result-panel {
    border-radius: 16px;
    background: rgba(15, 23, 42, 0.7);
    border: 1px solid rgba(148, 163, 184, 0.2);
    color: #e5e7eb;
  }

  .hero-qr {
    position: relative;
    background: rgba(255, 255, 255, 0.08);
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: 18px;
    padding: 16px;
    text-align: center;
    min-width: 160px;
    backdrop-filter: blur(8px);
    animation: floatCard 5s ease-in-out infinite;
  }

  .hero-qr img {
    width: 140px;
    height: 140px;
    border-radius: 12px;
    background: #fff;
    padding: 6px;
  }

  .hero-qr span {
    display: block;
    margin-top: 10px;
    font-size: 12px;
    letter-spacing: 0.6px;
    color: rgba(248, 250, 252, 0.85);
  }

  .user-page .btn-primary {
    background-color: #e50914;
    border-color: #e50914;
  }

  .user-page .btn-primary:hover {
    background-color: #f6121d;
    border-color: #f6121d;
  }

  @keyframes floatGlow {
    0%,
    100% {
      transform: translateY(0) scale(1);
      opacity: 0.7;
    }
    50% {
      transform: translateY(10px) scale(1.05);
      opacity: 1;
    }
  }

  @keyframes twinkle {
    0%,
    100% {
      transform: scale(0.6);
      opacity: 0.4;
    }
    50% {
      transform: scale(1);
      opacity: 0.9;
    }
  }

  @keyframes slideFadeIn {
    0% {
      opacity: 0;
      transform: translateY(10px);
    }
    100% {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes pulseGlow {
    0%,
    100% {
      box-shadow: 0 0 0 rgba(229, 9, 20, 0.35);
    }
    50% {
      box-shadow: 0 0 18px rgba(229, 9, 20, 0.45);
    }
  }

  @keyframes floatCard {
    0%,
    100% {
      transform: translateY(0);
    }
    50% {
      transform: translateY(-6px);
    }
  }

  @media (max-width: 768px) {
    .hero-banner {
      padding: 26px 20px;
      border-radius: 18px;
    }

    .hero-layout {
      flex-direction: column;
      text-align: center;
    }

    .hero-content {
      max-width: 100%;
    }

    .hero-actions {
      flex-direction: column;
      align-items: stretch;
    }

    .hero-actions .btn {
      width: 100%;
      justify-content: center;
    }

    .d-flex.justify-content-between.align-items-center {
      flex-direction: column;
      align-items: flex-start !important;
      gap: 12px;
    }

    .frost-card {
      border-radius: 14px;
    }

    .service-button {
      text-align: center;
    }

    .hero-qr {
      width: 100%;
    }

    .hero-qr img {
      width: 120px;
      height: 120px;
    }

    #result .form-control {
      word-break: break-all;
    }
  }
</style>
<!-- Flash Messages -->
{% with messages = get_flashed_messages(with_categories=true) %} {% if messages
%} {% for category, message in messages %}
<div
  class="alert alert-{{ category }} alert-dismissible fade show"
  role="alert"
>
  {{ message }}
  <button
    type="button"
    class="btn-close"
    data-bs-dismiss="alert"
    aria-label="Close"
  ></button>
</div>
{% endfor %} {% endif %} {% endwith %}

<div class="container user-page">
  <div class="hero-banner mb-4">
    <div class="floating-stars">
      <span></span>
      <span></span>
      <span></span>
      <span></span>
    </div>
    <div class="hero-layout">
      <div class="hero-content">
        <div class="hero-pill mb-3">
          <i class="fas fa-crown"></i>
          Netflix 
        </div>
        <h1 class="hero-title">مرحباً بك في موقع Netflix </h1>
        <p class="hero-subtitle">
          بوابتك السريعة لخدمات الحساب وإدارة الطلبات بواجهة عصرية وحركات ترحيب
          مميزة.
        </p>
        <div class="hero-actions d-flex flex-wrap gap-3">
          <a href="#services" class="btn btn-danger">
            <i class="fas fa-bolt me-2"></i> ابدأ الآن
          </a>
          <a href="{{ url_for('index') }}" class="btn btn-outline-light">
            <i class="fas fa-home me-2"></i> الصفحة الرئيسية
          </a>
        </div>
      </div>
      
    </div>
  </div>
  <div class="row mb-4">
    <div class="col-md-12">
      <div class="d-flex justify-content-between align-items-center">
        <h2>مرحباً بك في لوحة المستخدم</h2>
        <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
          <i class="fas fa-home"></i> الصفحة الرئيسية
        </a>
      </div>
    </div>
  </div>

  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card h-100 frost-card">
        <div class="card-body">
          <h5 class="card-title">معلومات الحساب</h5>
          <div class="mb-3">
            <label class="form-label">نوع المستخدم</label>
            <input
              type="text"
              class="form-control"
              value="{{ role }}"
              readonly
            />
          </div>
          <div class="mb-3">
            <label for="account" class="form-label">الحساب</label>
            <input
              type="text"
              class="form-control"
              id="account"
              dir="ltr"
              placeholder="أدخل الحساب هنا"
            />
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card h-100 frost-card" id="services">
        <div class="card-body">
          <h5 class="card-title">الخدمات المتاحة</h5>
          <p class="text-muted">اختر الخدمة المطلوبة</p>
          <div class="d-grid gap-2">
            {% if role == 'normal1' %}
            <button
              onclick="fetchLoginCode()"
              class="btn btn-primary text-start service-button"
            >
              <i class="fas fa-sign-in-alt me-2"></i> طلب رمز تسجيل الدخول
            </button>
            <button
              onclick="fetchVerificationCode()"
              class="btn btn-primary text-start service-button"
            >
              <i class="fas fa-shield-alt me-2"></i> طلب رمز التحقق
            </button>
            <button
              onclick="fetchResidenceCode()"
              class="btn btn-primary text-start service-button"
            >
              <i class="fas fa-key me-2"></i> طلب رمز السكن
            </button>
            <button
              onclick="fetchResidenceUpdateLink()"
              class="btn btn-primary text-start service-button"
            >
              <i class="fas fa-link me-2"></i> طلب رابط تحديث السكن
            </button>
            {% elif role == 'normal2' %}
            <button
              onclick="fetchLoginCode()"
              class="btn btn-primary text-start service-button"
            >
              <i class="fas fa-sign-in-alt me-2"></i> طلب رمز تسجيل الدخول
            </button>
            <button
              onclick="fetchResidenceCode()"
              class="btn btn-primary text-start service-button"
            >
              <i class="fas fa-key me-2"></i> طلب رمز السكن
            </button>
            <button
              onclick="fetchVerificationCode()"
              class="btn btn-primary text-start service-button"
            >
              <i class="fas fa-shield-alt me-2"></i> طلب رمز التحقق
            </button>
            <button
              onclick="fetchResidenceUpdateLink()"
              class="btn btn-primary text-start service-button"
            >
              <i class="fas fa-link me-2"></i> طلب رابط تحديث السكن
            </button>
            <button
              onclick="fetchPasswordResetLink()"
              class="btn btn-primary text-start service-button"
            >
              <i class="fas fa-lock me-2"></i> طلب استعادة كلمة المرور
            </button>
            {% elif role == 'normal3' %}
            <button
              onclick="fetchLoginCode()"
              class="btn btn-primary text-start service-button"
            >
              <i class="fas fa-sign-in-alt me-2"></i> طلب رمز تسجيل الدخول
            </button>
            {% else %}
            <div class="alert alert-warning mb-0">نوع مستخدم غير معروف</div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-12">
      <div class="card result-panel">
        <div class="card-body">
          <h5 class="card-title">نتيجة الطلب</h5>
          <div id="result" class="mt-3">
            <div class="alert alert-info mb-0">
              <i class="fas fa-info-circle me-2"></i> الرجاء إدخال الحساب
              واختيار الخدمة المطلوبة
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
/>
<script>
  function copyToClipboard(text) {
    try {
      navigator.clipboard
        .writeText(text)
        .then(() => {
          const copyBtn = document.getElementById("copyBtn");
          if (copyBtn) {
            copyBtn.innerHTML = '<i class="fas fa-check"></i> تم النسخ';
            setTimeout(() => {
              copyBtn.innerHTML = '<i class="fas fa-copy"></i> نسخ';
            }, 2000);
          }
        })
        .catch((err) => {
          console.error("Failed to copy:", err);
          alert("فشل نسخ النص. يرجى المحاولة مرة أخرى.");
        });
    } catch (err) {
      console.error("Copy error:", err);
      alert("فشل نسخ النص. يرجى المحاولة مرة أخرى.");
    }
  }

  async function callApi(endpoint, account) {
    const resultDiv = document.getElementById("result");
    if (!resultDiv) return;

    try {
      if (!account) {
        resultDiv.innerHTML = `
          <div class="alert alert-warning mb-0">
            <i class="fas fa-exclamation-triangle"></i> الرجاء إدخال الحساب
          </div>
        `;
        return;
      }

      account = account.trim();
      if (!account) {
        resultDiv.innerHTML = `
          <div class="alert alert-warning mb-0">
            <i class="fas fa-exclamation-triangle"></i> الرجاء إدخال حساب صحيح
          </div>
        `;
        return;
      }

      // Show loading state
      resultDiv.innerHTML = `
        <div class="alert alert-info">
          <i class="fas fa-spinner fa-spin"></i> جاري البحث...
        </div>
      `;

      const response = await fetch(`/api/${endpoint}`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Accept: "application/json",
          Origin: window.location.origin,
          "X-Requested-With": "XMLHttpRequest",
        },
        credentials: "include",
        mode: "cors",
        body: JSON.stringify({ account: account }),
      });

      let data;
      try {
        data = await response.json();
      } catch (e) {
        console.error("JSON Parse Error:", e);
        throw new Error("فشل في قراءة البيانات من الخادم");
      }

      if (!response.ok) {
        throw new Error(data.error || "حدث خطأ في الخادم");
      }

      if (data.error) {
        resultDiv.innerHTML = `
          <div class="alert alert-danger mb-0">
            <i class="fas fa-exclamation-circle"></i> ${data.error}
          </div>
        `;
        return;
      }

      let content = "";
      if (data.link) {
        content = data.link;
      } else if (data.code) {
        content = data.code;
      } else if (data.result) {
        content = data.result;
      }

      if (!content) {
        resultDiv.innerHTML = `
          <div class="alert alert-warning mb-0">
            <i class="fas fa-exclamation-triangle"></i> لم يتم العثور على نتيجة لهذا الطلب
          </div>
        `;
        return;
      }

      // Escape HTML to prevent XSS
      const escapedContent = content.replace(/[&<>"']/g, function (m) {
        const map = {
          "&": "&amp;",
          "<": "&lt;",
          ">": "&gt;",
          '"': "&quot;",
          "'": "&#39;",
        };
        return map[m];
      });

      resultDiv.innerHTML = `
        <div class="alert alert-success mb-0">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <span><i class="fas fa-check-circle"></i> تم جلب البيانات بنجاح</span>
            <button id="copyBtn" class="btn btn-sm btn-outline-success" onclick="copyToClipboard('${escapedContent}')">
              <i class="fas fa-copy"></i> نسخ
            </button>
          </div>
          <div class="form-control bg-light">${escapedContent}</div>
          ${
            data.link
              ? `<a href="${escapedContent}" class="btn btn-success w-100 mt-2" target="_blank" rel="noopener noreferrer">فتح الرابط</a>`
              : ""
          }
        </div>
      `;
    } catch (error) {
      console.error("API Error:", error);
      resultDiv.innerHTML = `
        <div class="alert alert-danger mb-0">
          <i class="fas fa-exclamation-circle"></i> ${
            error.message || "حدث خطأ في العملية"
          }
        </div>
      `;
    }
  }

  async function fetchResidenceCode() {
    const account = document.getElementById("account").value;
    await callApi("fetch-residence-code", account);
  }

  async function fetchResidenceUpdateLink() {
    const account = document.getElementById("account").value;
    await callApi("fetch-residence-update-link", account);
  }

  async function fetchLoginCode() {
    const account = document.getElementById("account").value;
    await callApi("fetch-login-code", account);
  }

  async function fetchPasswordResetLink() {
    const account = document.getElementById("account").value;
    await callApi("fetch-password-reset-link", account);
  }

  async function fetchVerificationCode() {
    const account = document.getElementById("account").value;
    await callApi("fetch-verification-code", account);
  }
</script>
{% endblock %}
